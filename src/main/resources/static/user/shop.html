<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘¨è¾¹å•†åŸ - èŒå® ä¹å›­</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .shop-banner {
            background-color: #3498db;
            color: white;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 30px;
            border-radius: 5px;
        }
        
        .shop-banner h1 {
            font-size: 32px;
            margin-bottom: 15px;
        }
        
        .shop-banner p {
            font-size: 18px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .filter-panel {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 30px;
        }
        
        .filter-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .filter-item {
            flex: 1;
            min-width: 200px;
        }
        
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .product-card {
            border-radius: 5px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
        }
        
        .product-image {
            width: 100%;
            height: 200px;
            background-color: #f1f2f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
        }
        
        .product-info {
            padding: 20px;
        }
        
        .product-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .product-price {
            color: #e74c3c;
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .product-stock {
            margin-bottom: 15px;
            font-size: 14px;
        }
        
        .stock-available {
            color: #2ecc71;
        }
        
        .stock-limited {
            color: #f39c12;
        }
        
        .stock-out {
            color: #e74c3c;
        }
        
        .product-actions {
            display: flex;
            gap: 10px;
        }
        
        .quantity-input {
            display: flex;
            align-items: center;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .quantity-btn {
            padding: 8px 12px;
            border: none;
            background-color: #f1f2f6;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
        }
        
        .quantity-field {
            width: 60px;
            text-align: center;
            border: none;
            padding: 8px 0;
            font-size: 16px;
        }
        
        .buy-btn {
            flex: 1;
            padding: 10px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .buy-btn:hover {
            background-color: #2980b9;
        }
        
        .buy-btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .no-products {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        
        .purchase-info {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .purchase-product {
            margin-bottom: 20px;
        }
        
        .purchase-total {
            border-top: 1px solid #ddd;
            padding-top: 15px;
        }
        
        .text-danger {
            color: #e74c3c;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand">èŒå® ä¹å›­</div>
            <ul class="navbar-nav">
                <li><a href="index.html">é¦–é¡µ</a></li>
                <li><a href="pets.html">èŒå® å±•ç¤º</a></li>
                <li><a href="reservations.html">æˆ‘çš„é¢„çº¦</a></li>
                <li><a href="shop.html" class="active">å‘¨è¾¹å•†åŸ</a></li>
                <li><a href="orders.html">æˆ‘çš„è®¢å•</a></li>
                <li><a href="profile.html">ä¸ªäººä¸­å¿ƒ</a></li>
                <li><a href="javascript:void(0);" onclick="logout()">é€€å‡ºç™»å½•</a></li>
            </ul>
        </div>
    </nav>
    
    <!-- å†…å®¹åŒº -->
    <div class="container">
        <!-- å•†åŸæ¨ªå¹… -->
        <div class="shop-banner">
            <h1>èŒå® å‘¨è¾¹å•†åŸ</h1>
            <p>æŒ‘é€‰èŒå® ç›¸å…³çš„ç²¾ç¾å•†å“ï¼Œå¸¦èµ°ä¸€ä»½ç¾å¥½çš„çºªå¿µï¼Œå»¶ç»­æ‚¨ä¸èŒå® ä»¬çš„ç¼˜åˆ†ã€‚</p>
        </div>
        
        <!-- ç­›é€‰é¢æ¿ -->
        <div class="filter-panel">
            <div class="filter-group">
                <div class="filter-item">
                    <label for="priceFilter" class="form-label">ä»·æ ¼èŒƒå›´</label>
                    <select id="priceFilter" class="form-control">
                        <option value="">å…¨éƒ¨ä»·æ ¼</option>
                        <option value="0-50">Â¥50ä»¥ä¸‹</option>
                        <option value="50-100">Â¥50-Â¥100</option>
                        <option value="100-200">Â¥100-Â¥200</option>
                        <option value="200-">Â¥200ä»¥ä¸Š</option>
                    </select>
                </div>
                
                <div class="filter-item">
                    <label for="stockFilter" class="form-label">åº“å­˜çŠ¶æ€</label>
                    <select id="stockFilter" class="form-control">
                        <option value="">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="true">æœ‰åº“å­˜</option>
                        <option value="false">æ— åº“å­˜</option>
                    </select>
                </div>
                
                <div class="filter-item">
                    <label for="searchInput" class="form-label">æœç´¢</label>
                    <input type="text" id="searchInput" class="form-control" placeholder="æœç´¢å•†å“åç§°...">
                </div>
                
                <div class="filter-item" style="display: flex; align-items: flex-end;">
                    <button class="btn btn-primary" onclick="filterProducts()">ç­›é€‰</button>
                </div>
            </div>
        </div>
        
        <!-- å•†å“ç½‘æ ¼ -->
        <div class="product-grid" id="productGrid">
            <!-- å•†å“æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
        </div>
    </div>
    
    <!-- ç¡®è®¤è´­ä¹°æ¨¡æ€æ¡† -->
    <div id="purchaseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ç¡®è®¤è´­ä¹°</h2>
                <span class="close-button">&times;</span>
            </div>
            <div class="modal-body">
                <form id="purchaseForm">
                    <input type="hidden" id="userId" name="userId">
                    <input type="hidden" id="productId" name="productId">
                    <input type="hidden" id="quantity" name="quantity">
                    <input type="hidden" id="totalPrice" name="totalPrice">
                    <input type="hidden" id="status" name="status" value="å¾…æ”¯ä»˜">
                    
                    <div class="purchase-info">
                        <div class="purchase-product">
                            <h3>å•†å“: <span id="productName"></span></h3>
                            <p>å•ä»·: <span id="productPrice"></span></p>
                            <p>æ•°é‡: <span id="purchaseQuantity"></span></p>
                            <p>åº“å­˜: <span id="productStock"></span></p>
                        </div>
                        <div class="purchase-total">
                            <h3>æ€»ä»·: <span id="purchaseTotalPrice" class="text-danger"></span></h3>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closePurchaseModal()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="confirmPurchase()">ç¡®è®¤è´­ä¹°</button>
                <button type="button" class="btn btn-success" onclick="payNow()">ç«‹å³æ”¯ä»˜</button>
            </div>
        </div>
    </div>
    
    <script src="../js/common.js"></script>
    <script>
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
        if (!checkLogin()) {
            window.location.href = '../login.html';
        }
        
        // è·å–ç”¨æˆ·ä¿¡æ¯
        const user = JSON.parse(sessionStorage.getItem('user'));
        
        // ä¸ºä¸åŒç±»å‹çš„å•†å“åˆ†é…è¡¨æƒ…ç¬¦å·
        const productEmojis = {
            'èŒå® é›¶é£ŸåŒ…': 'ğŸª',
            'å® ç‰©ç©å…·å¥—è£…': 'ğŸ§¸',
            'å® ç‰©æŠ¤ç†ç”¨å“': 'ğŸ§´',
            'èŒå® çºªå¿µç…§': 'ğŸ“·',
            'å® ç‰©å°å±‹': 'ğŸ '
        };
        
        // åŠ è½½å•†å“
        function loadProducts() {
            ajaxGet('/api/product', function(response) {
                if (response.code === 200) {
                    renderProductGrid(response.data);
                }
            });
        }
        
        // æ¸²æŸ“å•†å“ç½‘æ ¼
        function renderProductGrid(products) {
            const productGrid = document.getElementById('productGrid');
            productGrid.innerHTML = '';
            
            if (products.length === 0) {
                productGrid.innerHTML = '<div class="no-products">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å•†å“</div>';
                return;
            }
            
            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.dataset.id = product.id;
                
                const hasStock = product.stock > 0;
                const isLimitedStock = product.stock > 0 && product.stock <= 10;
                const productEmoji = productEmojis[product.name] || 'ğŸ';
                
                let stockClass = 'stock-available';
                let stockText = `åº“å­˜å……è¶³ (${product.stock})`;
                
                if (!hasStock) {
                    stockClass = 'stock-out';
                    stockText = 'æš‚æ— åº“å­˜';
                } else if (isLimitedStock) {
                    stockClass = 'stock-limited';
                    stockText = `åº“å­˜ç´§å¼  (ä»…å‰©${product.stock}ä»¶)`;
                }
                
                productCard.innerHTML = `
                    <div class="product-image">${productEmoji}</div>
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">${formatAmount(product.price)}</div>
                        <div class="product-stock ${stockClass}">${stockText}</div>
                        <div class="product-actions">
                            <div class="quantity-input">
                                <button type="button" class="quantity-btn" onclick="decreaseQuantity(this)">-</button>
                                <input type="text" class="quantity-field" value="1" min="1" max="${product.stock}" readonly>
                                <button type="button" class="quantity-btn" onclick="increaseQuantity(this, ${product.stock})">+</button>
                            </div>
                            <button class="buy-btn" onclick="buyProduct(${product.id})" ${!hasStock ? 'disabled' : ''}>
                                ${hasStock ? 'è´­ ä¹°' : 'ç¼ºè´§ä¸­'}
                            </button>
                        </div>
                    </div>
                `;
                
                productGrid.appendChild(productCard);
            });
        }
        
        // å¢åŠ æ•°é‡
        function increaseQuantity(btn, maxStock) {
            const input = btn.parentNode.querySelector('.quantity-field');
            let value = parseInt(input.value);
            if (value < maxStock) {
                input.value = value + 1;
            }
        }
        
        // å‡å°‘æ•°é‡
        function decreaseQuantity(btn) {
            const input = btn.parentNode.querySelector('.quantity-field');
            let value = parseInt(input.value);
            if (value > 1) {
                input.value = value - 1;
            }
        }
        
        // ç­›é€‰å•†å“
        function filterProducts() {
            const priceFilter = document.getElementById('priceFilter').value;
            const stockFilter = document.getElementById('stockFilter').value;
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            
            ajaxGet('/api/product', function(response) {
                if (response.code === 200) {
                    let filteredProducts = response.data;
                    
                    // æŒ‰ä»·æ ¼ç­›é€‰
                    if (priceFilter) {
                        const [minPrice, maxPrice] = priceFilter.split('-');
                        if (maxPrice) {
                            filteredProducts = filteredProducts.filter(product => 
                                product.price >= parseFloat(minPrice) && 
                                product.price < parseFloat(maxPrice)
                            );
                        } else {
                            filteredProducts = filteredProducts.filter(product => 
                                product.price >= parseFloat(minPrice)
                            );
                        }
                    }
                    
                    // æŒ‰åº“å­˜çŠ¶æ€ç­›é€‰
                    if (stockFilter === 'true') {
                        filteredProducts = filteredProducts.filter(product => product.stock > 0);
                    } else if (stockFilter === 'false') {
                        filteredProducts = filteredProducts.filter(product => product.stock === 0);
                    }
                    
                    // æŒ‰åç§°æœç´¢
                    if (searchInput) {
                        filteredProducts = filteredProducts.filter(product => 
                            product.name.toLowerCase().includes(searchInput)
                        );
                    }
                    
                    renderProductGrid(filteredProducts);
                }
            });
        }
        
        // è´­ä¹°å•†å“
        function buyProduct(productId) {
            // è·å–é€‰æ‹©çš„æ•°é‡
            const productCard = document.querySelector(`.product-card[data-id="${productId}"]`);
            const quantityInput = productCard.querySelector('.quantity-field');
            const quantity = parseInt(quantityInput.value);
            
            // è·å–å•†å“è¯¦æƒ…
            ajaxGet(`/api/product/${productId}`, function(response) {
                if (response.code === 200) {
                    const product = response.data;
                    
                    // æ£€æŸ¥åº“å­˜æ˜¯å¦è¶³å¤Ÿ
                    if (product.stock < quantity) {
                        showAlert(`åº“å­˜ä¸è¶³ï¼Œå½“å‰åº“å­˜: ${product.stock}`, 'warning');
                        return;
                    }
                    
                    // å¡«å……è´­ä¹°è¡¨å•
                    document.getElementById('userId').value = user.id;
                    document.getElementById('productId').value = product.id;
                    document.getElementById('quantity').value = quantity;
                    const totalPrice = product.price * quantity;
                    document.getElementById('totalPrice').value = totalPrice.toFixed(2);
                    
                    // æ›´æ–°æ¨¡æ€æ¡†æ˜¾ç¤ºå†…å®¹
                    document.getElementById('productName').textContent = product.name;
                    document.getElementById('productPrice').textContent = formatAmount(product.price);
                    document.getElementById('purchaseQuantity').textContent = quantity;
                    document.getElementById('productStock').textContent = product.stock;
                    document.getElementById('purchaseTotalPrice').textContent = formatAmount(totalPrice);
                    
                    // æ‰“å¼€è´­ä¹°æ¨¡æ€æ¡†
                    openModal('purchaseModal');
                } else {
                    showAlert(response.message, 'danger');
                }
            });
        }
        
        // å…³é—­è´­ä¹°æ¨¡æ€æ¡†
        function closePurchaseModal() {
            closeModal('purchaseModal');
        }
        
        // ç¡®è®¤è´­ä¹°ï¼ˆæ·»åŠ åˆ°å¾…æ”¯ä»˜è®¢å•ï¼‰
        function confirmPurchase() {
            const formData = getFormData('purchaseForm');
            
            ajaxPost('/api/order', formData, function(response) {
                if (response.code === 200) {
                    showAlert('è®¢å•å·²åˆ›å»ºï¼Œè¯·å‰å¾€è®¢å•é¡µé¢å®Œæˆæ”¯ä»˜', 'success');
                    closePurchaseModal();
                    
                    // è·³è½¬åˆ°è®¢å•é¡µé¢
                    setTimeout(() => {
                        window.location.href = 'orders.html';
                    }, 2000);
                } else {
                    showAlert(response.message, 'danger');
                }
            });
        }
        
        // ç«‹å³æ”¯ä»˜ï¼ˆæ·»åŠ åˆ°å·²æ”¯ä»˜è®¢å•ï¼‰
        function payNow() {
            const formData = getFormData('purchaseForm');
            formData.status = 'å·²æ”¯ä»˜';
            
            ajaxPost('/api/order', formData, function(response) {
                if (response.code === 200) {
                    showAlert('è´­ä¹°æˆåŠŸï¼', 'success');
                    closePurchaseModal();
                    
                    // åˆ·æ–°å•†å“åˆ—è¡¨
                    setTimeout(() => {
                        loadProducts();
                    }, 1000);
                } else {
                    showAlert(response.message, 'danger');
                }
            });
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
            
            // æœç´¢æ¡†å›è½¦äº‹ä»¶
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    filterProducts();
                }
            });
        });
    </script>
</body>
</html>
